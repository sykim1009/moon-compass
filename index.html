<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moon Locator</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: black;
      color: white;
      margin: 0;
      padding: 1em;
    }
    #direction {
      margin-top: 20px;
      font-size: 1.2em;
      line-height: 1.6;
      white-space: pre-line;
    }
    #compass, #altitudeDiagram, #azimuthDiagram {
      margin-top: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #map {
      margin-top: 20px;
      height: 300px;
      width: 300px;
      margin-left: auto;
      margin-right: auto;
    }
    @media (max-width: 600px) {
      #compass, #altitudeDiagram, #azimuthDiagram, #map {
        width: 90%;
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸŒ™ Moon Locator</h1>
  <button onclick="init()">Start</button>
  <div id="direction">Waiting for data...</div>
  <canvas id="compass" width="300" height="300"></canvas>
  <div id="map"></div>
  <canvas id="azimuthDiagram" width="400" height="300"></canvas>
  <canvas id="altitudeDiagram" width="300" height="150"></canvas>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ============= ë‹¬ ê³„ì‚°ìš© í•¨ìˆ˜ë“¤ =============
    function toJulian(date) {
      return date / 86400000 + 2440587.5;
    }

    function fromJulian(j) {
      return new Date((j - 2440587.5) * 86400000);
    }

    function moonPosition(date, lat, lon) {
      const rad = Math.PI / 180;
      const day = toJulian(date) - 2451545.0;

      // ë” ì •í™•í•œ ë‹¬ì˜ ìœ„ì¹˜ ê³„ì‚°
      const L = (218.316 + 13.176396 * day) * rad;
      const M = (134.963 + 13.064993 * day) * rad;
      const F = (93.272 + 13.229350 * day) * rad;
      const D = (297.850 + 12.190749 * day) * rad;
      const MS = (357.529 + 0.985600 * day) * rad;

      // ë‹¬ì˜ ê²½ë„ (ë” ë§ì€ í•­ ì¶”ê°€)
      const lonEcl = L + 
        6.289 * Math.sin(M) * rad +
        1.274 * Math.sin(2*D - M) * rad +
        0.658 * Math.sin(2*D) * rad -
        0.186 * Math.sin(MS) * rad -
        0.059 * Math.sin(2*M - 2*D) * rad -
        0.057 * Math.sin(M - 2*D + MS) * rad;

      // ë‹¬ì˜ ìœ„ë„
      const latEcl = 5.128 * Math.sin(F) * rad +
        0.281 * Math.sin(M + F) * rad +
        0.278 * Math.sin(M - F) * rad +
        0.173 * Math.sin(2*D - F) * rad;

      const e = (23.439 - 0.0000004 * day) * rad;

      // ì ê²½ê³¼ ì ìœ„ ê³„ì‚°
      const ra = Math.atan2(
        Math.sin(lonEcl) * Math.cos(e) - Math.tan(latEcl) * Math.sin(e),
        Math.cos(lonEcl)
      );
      const dec = Math.asin(
        Math.sin(latEcl) * Math.cos(e) + Math.cos(latEcl) * Math.sin(e) * Math.sin(lonEcl)
      );

      // ì§€ë°© í•­ì„±ì‹œ ê³„ì‚°
      const GMST = (18.697374558 + 24.06570982441908 * day) % 24;
      const LST = (GMST * 15 + lon) * rad;
      const H = LST - ra;

      const phi = lat * rad;

      // ê³ ë„ì™€ ë°©ìœ„ê° ê³„ì‚°
      const alt = Math.asin(Math.sin(phi) * Math.sin(dec) + Math.cos(phi) * Math.cos(dec) * Math.cos(H));
      const az = Math.atan2(
        -Math.sin(H),
        Math.tan(dec) * Math.cos(phi) - Math.sin(phi) * Math.cos(H)
      );

      return {
        azimuth: (az / rad + 360) % 360,
        altitude: alt / rad,
        dec: dec,
        ra: ra
      };
    }

    function getMoonPhase(date) {
      const lp = 2551442.88; // í‰ê·  ì‚­ë§ì›” (ì´ˆ)
      const newMoon = new Date(Date.UTC(2020, 0, 24, 21, 42)); // ë” ì •í™•í•œ ê¸°ì¤€ ì‹ ì›”
      const phase = ((date.getTime() - newMoon.getTime()) / 1000) % lp;
      const phaseFraction = phase / lp;
      return phaseFraction;
    }

    function getMoonPhaseEmoji(phase) {
      if (phase < 0.05 || phase >= 0.95) return "ğŸŒ‘"; // ì‹ ì›”
      if (phase < 0.25) return "ğŸŒ’"; // ìƒí˜„ë‹¬
      if (phase < 0.45) return "ğŸŒ“"; // ìƒí˜„ë‹¬ (1/4)
      if (phase < 0.55) return "ğŸŒ”"; // ìƒí˜„ë‹¬ (3/4)
      if (phase < 0.75) return "ğŸŒ•"; // ë³´ë¦„ë‹¬
      if (phase < 0.85) return "ğŸŒ–"; // í•˜í˜„ë‹¬ (3/4)
      if (phase < 0.95) return "ğŸŒ—"; // í•˜í˜„ë‹¬ (1/4)
      return "ğŸŒ˜"; // í•˜í˜„ë‹¬
    }

    function moonRiseSet(date, lat, lon) {
      const rad = Math.PI / 180;
      const h0 = -0.833 * rad; // ì§€í‰ì„  ê¸°ì¤€
      
      // ë‹¹ì¼ 00:00ë¶€í„° ë‹¤ìŒë‚  00:00ê¹Œì§€ ê³„ì‚°
      const startOfDay = new Date(date);
      startOfDay.setHours(0, 0, 0, 0);
      
      let riseTime = null;
      let setTime = null;
      let prevAlt = null;

      // 5ë¶„ ê°„ê²©ìœ¼ë¡œ ì²´í¬ (ë” ì •í™•í•˜ê³  ë¹ ë¦„)
      for (let i = 0; i <= 24 * 12; i++) { // 24ì‹œê°„ * 12 (5ë¶„ ê°„ê²©)
        const checkTime = new Date(startOfDay.getTime() + i * 5 * 60 * 1000);
        const moon = moonPosition(checkTime, lat, lon);
        
        // ì§€í‰ì„ ì„ ê¸°ì¤€ìœ¼ë¡œ í•œ ê³ ë„ ê³„ì‚°
        const altRad = moon.altitude * rad;
        
        if (prevAlt !== null) {
          // ë– ì˜¤ë¦„ ê°ì§€ (ì´ì „: ì§€í‰ì„  ì•„ë˜, í˜„ì¬: ì§€í‰ì„  ìœ„)
          if (prevAlt <= h0 && altRad > h0 && !riseTime) {
            // ë” ì •í™•í•œ ì‹œê°„ì„ ìœ„í•´ ì„ í˜• ë³´ê°„
            const timeDiff = 5 * 60 * 1000; // 5ë¶„
            const altDiff = altRad - prevAlt;
            const ratio = (h0 - prevAlt) / altDiff;
            riseTime = new Date(checkTime.getTime() - timeDiff + ratio * timeDiff);
          }
          
          // ì§€ëŠ” ê²ƒ ê°ì§€ (ì´ì „: ì§€í‰ì„  ìœ„, í˜„ì¬: ì§€í‰ì„  ì•„ë˜)
          if (prevAlt >= h0 && altRad < h0 && !setTime) {
            // ë” ì •í™•í•œ ì‹œê°„ì„ ìœ„í•´ ì„ í˜• ë³´ê°„
            const timeDiff = 5 * 60 * 1000; // 5ë¶„
            const altDiff = altRad - prevAlt;
            const ratio = (h0 - prevAlt) / altDiff;
            setTime = new Date(checkTime.getTime() - timeDiff + ratio * timeDiff);
          }
        }
        
        prevAlt = altRad;
      }

      const times = {};
      
      // ê·¹ì§€ë°©ì´ë‚˜ íŠ¹ìˆ˜í•œ ê²½ìš° ì²˜ë¦¬
      if (!riseTime && !setTime) {
        const moon = moonPosition(date, lat, lon);
        if (moon.altitude > 0) {
          times.status = "Always above horizon";
        } else {
          times.status = "Always below horizon";
        }
      } else {
        if (riseTime) times.rise = riseTime;
        if (setTime) times.set = setTime;
      }

      return times;
    }

    // ============= ë©”ì¸ ë¡œì§ =============
    let moonData = null;
    let updateTimer = null;
    let map = null;
    let marker = null;

    function init() {
      if (navigator.geolocation) {
        if (updateTimer) {
          clearInterval(updateTimer);
          updateTimer = null;
        }

        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          if (!map) {
            map = L.map('map').setView([lat, lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            marker = L.marker([lat, lon]).addTo(map)
              .bindPopup('Your Location').openPopup();
          } else {
            map.setView([lat, lon], 13);
            marker.setLatLng([lat, lon]);
          }

          function update() {
            const now = new Date();
            const moon = moonPosition(now, lat, lon);
            const phase = getMoonPhase(now);
            const emoji = getMoonPhaseEmoji(phase);
            const times = moonRiseSet(now, lat, lon);

            let text =
              `Your position: ${lat.toFixed(4)}, ${lon.toFixed(4)}\n` +
              `Moon â†’ ${emoji} (Phase: ${(phase * 100).toFixed(1)}%)\n` +
              `Azimuth: ${moon.azimuth.toFixed(1)}Â°, Altitude: ${moon.altitude.toFixed(1)}Â°\n`;

            if (times.rise || times.set) {
              if (times.rise) {
                text += `Rise: ${times.rise.toLocaleTimeString()}\n`;
              }
              if (times.set) {
                text += `Set: ${times.set.toLocaleTimeString()}`;
              }
            } else if (times.status) {
              text += `Status: ${times.status}`;
            }

            document.getElementById("direction").textContent = text;
            moonData = moon;

            // ë‹¤ì´ì–´ê·¸ë¨ ì—…ë°ì´íŠ¸
            updateAzimuthDiagram(moon.azimuth, moon.altitude);
            updateAltitudeDiagram(moon.azimuth, moon.altitude);
          }

          update();
          updateTimer = setInterval(update, 30000); // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸

          setupCompass();
        }, (error) => {
          console.error("Geolocation error:", error);
          alert("Geolocation failed: " + error.message);
        });
      } else {
        alert("Geolocation not supported");
      }
    }

    function setupCompass() {
      if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === "granted") {
              window.addEventListener("deviceorientation", debouncedUpdateHeading, true);
            } else {
              alert("Device orientation permission denied");
            }
          })
          .catch(() => alert("Device orientation not supported"));
      } else if (window.DeviceOrientationEvent) {
        window.addEventListener("deviceorientationabsolute", debouncedUpdateHeading, true);
      } else {
        // ë‚˜ì¹¨ë°˜ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ë„ ê¸°ë³¸ í‘œì‹œ
        updateCompassStatic();
      }
    }

    function updateCompassStatic() {
      if (!moonData) return;
      
      const canvas = document.getElementById("compass");
      const ctx = canvas.getContext("2d");
      const radius = canvas.width / 2;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ë‚˜ì¹¨ë°˜ ë°°ê²½
      ctx.beginPath();
      ctx.arc(radius, radius, radius - 10, 0, 2 * Math.PI);
      ctx.fillStyle = "#333";
      ctx.fill();
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.stroke();

      // ë°©í–¥ í‘œì‹œ
      ctx.fillStyle = "#fff";
      ctx.font = "16px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("N", radius, 20);
      ctx.fillText("E", canvas.width - 20, radius);
      ctx.fillText("S", radius, canvas.height - 20);
      ctx.fillText("W", 20, radius);

      // ë‹¬ ìœ„ì¹˜ í‘œì‹œ
      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate((moonData.azimuth - 90) * Math.PI / 180); // -90ë„ë¡œ ë³´ì • (ë¶ìª½ì´ ìœ„)
      ctx.font = "24px sans-serif";
      ctx.fillStyle = "yellow";
      ctx.fillText("ğŸŒ™", 0, -radius + 30);
      ctx.restore();
    }

    function updateHeading(e) {
      if (!moonData || e.alpha == null) {
        updateCompassStatic();
        return;
      }

      const heading = 360 - e.alpha;
      const canvas = document.getElementById("compass");
      const ctx = canvas.getContext("2d");
      const radius = canvas.width / 2;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ë‚˜ì¹¨ë°˜ ë°°ê²½
      ctx.beginPath();
      ctx.arc(radius, radius, radius - 10, 0, 2 * Math.PI);
      ctx.fillStyle = "#333";
      ctx.fill();
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.stroke();

      // ë°©í–¥ í‘œì‹œ
      ctx.fillStyle = "#fff";
      ctx.font = "16px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("N", radius, 20);
      ctx.fillText("E", canvas.width - 20, radius);
      ctx.fillText("S", radius, canvas.height - 20);
      ctx.fillText("W", 20, radius);

      // í˜„ì¬ ë°©í–¥ (ë¹¨ê°„ í™”ì‚´í‘œ)
      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(heading * Math.PI / 180);
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.moveTo(0, -radius + 20);
      ctx.lineTo(-10, -radius + 40);
      ctx.lineTo(10, -radius + 40);
      ctx.closePath();
      ctx.fill();
      ctx.restore();

      // ë‹¬ ìœ„ì¹˜
      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(moonData.azimuth * Math.PI / 180);
      ctx.font = "24px sans-serif";
      ctx.fillStyle = "yellow";
      ctx.fillText("ğŸŒ™", 0, -radius + 30);
      ctx.restore();
    }

    function updateAzimuthDiagram(azimuth, altitude) {
      const canvas = document.getElementById("azimuthDiagram");
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;
      const centerX = width / 2;
      const centerY = height * 0.8; // ì•„ë˜ìª½ìœ¼ë¡œ ì´ë™
      const radius = Math.min(width, height) * 0.35;

      // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
      ctx.clearRect(0, 0, width, height);

      // ë°°ê²½ ì› (ì§€í‰ì„ )
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = "#666";
      ctx.lineWidth = 2;
      ctx.stroke();

      // ë°©í–¥ í‘œì‹œ (N, E, S, W)
      ctx.fillStyle = "#fff";
      ctx.font = "16px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      
      // N (0Â°)
      ctx.fillText("N", centerX, centerY - radius - 20);
      ctx.fillText("0Â°", centerX, centerY - radius - 35);
      
      // E (90Â°)
      ctx.fillText("E", centerX + radius + 20, centerY);
      ctx.fillText("90Â°", centerX + radius + 35, centerY);
      
      // S (180Â°)
      ctx.fillText("S", centerX, centerY + radius + 20);
      ctx.fillText("180Â°", centerX, centerY + radius + 35);
      
      // W (270Â°)
      ctx.fillText("W", centerX - radius - 20, centerY);
      ctx.fillText("270Â°", centerX - radius - 35, centerY);

      // ê³ ë„ ë™ì‹¬ì›ë“¤ (30Â°, 60Â°, 90Â°)
      ctx.strokeStyle = "#444";
      ctx.lineWidth = 1;
      ctx.setLineDash([5, 5]);
      
      for (let alt = 30; alt <= 90; alt += 30) {
        const r = radius * Math.cos(alt * Math.PI / 180);
        ctx.beginPath();
        ctx.arc(centerX, centerY, r, 0, 2 * Math.PI);
        ctx.stroke();
        
        // ê³ ë„ ë ˆì´ë¸”
        ctx.fillStyle = "#aaa";
        ctx.font = "12px sans-serif";
        ctx.fillText(`${alt}Â°`, centerX + r + 5, centerY - 5);
      }
      
      ctx.setLineDash([]);

      // ë‹¬ì˜ ìœ„ì¹˜ ê³„ì‚°
      const azRad = (azimuth - 90) * Math.PI / 180; // -90ë„ë¡œ ë³´ì • (ë¶ìª½ì´ ìœ„)
      const altRad = altitude * Math.PI / 180;
      
      // 3Dì—ì„œ 2Dë¡œ íˆ¬ì˜ (stereographic projection)
      const projectionRadius = radius * Math.cos(altRad);
      const moonX = centerX + projectionRadius * Math.cos(azRad);
      const moonY = centerY + projectionRadius * Math.sin(azRad);
      
      // ë‹¬ í‘œì‹œ
      ctx.fillStyle = altitude >= 0 ? "yellow" : "#666";
      ctx.beginPath();
      ctx.arc(moonX, moonY, 12, 0, 2 * Math.PI);
      ctx.fill();
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // ë‹¬ ì´ëª¨ì§€
      ctx.font = "16px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ğŸŒ™", moonX, moonY);
      
      // ì¤‘ì‹¬ì—ì„œ ë‹¬ê¹Œì§€ ì„ 
      if (altitude >= 0) {
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(moonX, moonY);
        ctx.strokeStyle = "rgba(255, 255, 0, 0.5)";
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      
      // ì •ë³´ í‘œì‹œ
      ctx.fillStyle = "#fff";
      ctx.font = "14px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText(`Azimuth: ${azimuth.toFixed(1)}Â°`, centerX, 20);
      ctx.fillText(`Altitude: ${altitude.toFixed(1)}Â°`, centerX, 40);
      ctx.fillText("3D Azimuth-Altitude View", centerX, height - 10);
    }

    function updateAltitudeDiagram(azimuth, altitude) {
      const canvas = document.getElementById("altitudeDiagram");
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;
      const centerX = width / 2;
      const centerY = height - 20;

      // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
      ctx.clearRect(0, 0, width, height);

      // ì§€í‰ì„  ê·¸ë¦¬ê¸°
      ctx.beginPath();
      ctx.moveTo(0, centerY);
      ctx.lineTo(width, centerY);
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.stroke();

      // ê³ ë„ ëˆˆê¸ˆ
      ctx.fillStyle = "#fff";
      ctx.font = "12px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("90Â°", 10, 20);
      ctx.fillText("0Â°", 10, centerY);
      ctx.fillText("-90Â°", 10, height - 20);

      // ë‹¬ì˜ ê³ ë„ í‘œì‹œ
      const maxAltitude = 90;
      const y = centerY - (altitude / maxAltitude) * (centerY - 20);
      
      // ë‹¬ ì•„ì´ì½˜
      ctx.beginPath();
      ctx.arc(centerX, y, 10, 0, 2 * Math.PI);
      ctx.fillStyle = altitude >= 0 ? "yellow" : "#666";
      ctx.fill();
      ctx.strokeStyle = "#fff";
      ctx.stroke();

      // ë°©ìœ„ê°ê³¼ ê³ ë„ í‘œì‹œ
      ctx.fillStyle = "#fff";
      ctx.font = "14px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText(`Az: ${azimuth.toFixed(1)}Â° Alt: ${altitude.toFixed(1)}Â°`, centerX, height - 5);
    }

    let lastHeadingUpdate = 0;
    function debouncedUpdateHeading(e) {
      const now = performance.now();
      if (now - lastHeadingUpdate < 100) return;
      lastHeadingUpdate = now;
      requestAnimationFrame(() => updateHeading(e));
    }
  </script>
</body>
</html>