<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moon Locator (No API)</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: black;
      color: white;
      margin: 0;
      padding: 1em;
    }
    #direction {
      margin-top: 20px;
      font-size: 1.2em;
      line-height: 1.6;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>üåô Moon Locator (No API)</h1>
  <button onclick="init()">Start</button>
  <div id="direction">Waiting for data...</div>

  <script>
    function toJulian(date) {
      return date / 86400000 + 2440587.5;
    }

    function moonPosition(date, lat, lon) {
      const rad = Math.PI / 180;
      const day = toJulian(date) - 2451545.0;

      // üåô Îã¨ ÌèâÍ∑† Í∑ºÏÇ¨ Í∂§ÎèÑ ÏöîÏÜå
      const L = (218.316 + 13.176396 * day) * rad; // ÌèâÍ∑† Ìô©Í≤Ω
      const M = (134.963 + 13.064993 * day) * rad; // ÌèâÍ∑† Í∑ºÏ†êÏù¥Í∞Å
      const F = (93.272 + 13.229350 * day) * rad;  // ÌèâÍ∑† Ìé∏Í∞Å

      // Ìô©Í≤Ω/Ìô©ÏúÑ Í∑ºÏÇ¨
      const lonEcl = L + 6.289 * rad * Math.sin(M);
      const latEcl = 5.128 * rad * Math.sin(F);

      // Ìô©ÎèÑÍ≤ΩÏÇ¨
      const e = (23.439 - 0.0000004 * day) * rad;

      // Ï†ÅÍ≤Ω/Ï†ÅÏúÑ
      const ra = Math.atan2(
        Math.sin(lonEcl) * Math.cos(e) - Math.tan(latEcl) * Math.sin(e),
        Math.cos(lonEcl)
      );
      const dec = Math.asin(
        Math.sin(latEcl) * Math.cos(e) + Math.cos(latEcl) * Math.sin(e) * Math.sin(lonEcl)
      );

      // üåç GMST ‚Üí LST
      const GMST = (18.697374558 + 24.06570982441908 * day) % 24;
      const LST = (GMST * 15 + lon) * rad; // lonÏùÄ degree Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©

      const H = LST - ra; // ÏãúÍ∞ÑÍ∞Å

      // Í≥†ÎèÑ/Î∞©ÏúÑÍ∞Å
      const phi = lat * rad;
      const alt = Math.asin(
        Math.sin(phi) * Math.sin(dec) + Math.cos(phi) * Math.cos(dec) * Math.cos(H)
      );
      const az = Math.atan2(
        -Math.sin(H),
        Math.tan(dec) * Math.cos(phi) - Math.sin(phi) * Math.cos(H)
      );

      return {
        azimuth: (az / rad + 360) % 360,
        altitude: alt / rad
      };
    }

    function init() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const now = new Date();

          const moon = moonPosition(now, lat, lon);

          document.getElementById("direction").textContent =
            `Your position: ${lat.toFixed(4)}, ${lon.toFixed(4)}\n` +
            `Moon ‚Üí Azimuth: ${moon.azimuth.toFixed(1)}¬∞, Altitude: ${moon.altitude.toFixed(1)}¬∞`;

          setupCompass(moon.azimuth);
        }, err => {
          document.getElementById("direction").textContent = "‚ö†Ô∏è GPS permission denied.";
        });
      } else {
        alert("Geolocation not supported");
      }
    }

    function setupCompass(moonAzimuth) {
      if (window.DeviceOrientationEvent) {
        window.addEventListener("deviceorientationabsolute", e => updateHeading(e, moonAzimuth), true);
        window.addEventListener("deviceorientation", e => updateHeading(e, moonAzimuth), true);
      } else {
        document.getElementById("direction").textContent += "\n(No compass support)";
      }
    }

    function updateHeading(e, moonAzimuth) {
      if (e.alpha != null) {
        const heading = 360 - e.alpha; // Î∂ÅÏ™Ω Í∏∞Ï§Ä
        let text = document.getElementById("direction").textContent.split("\n")[0] + "\n";
        text += `Moon ‚Üí Azimuth: ${moonAzimuth.toFixed(1)}¬∞\n`;
        text += `Your heading: ${heading.toFixed(0)}¬∞`;

        const diff = ((moonAzimuth - heading + 540) % 360) - 180;
        if (Math.abs(diff) < 15) {
          text += `\nüëâ Pointing at the moon!`;
        } else if (diff > 0) {
          text += `\n‚Üó Turn right ${Math.abs(diff).toFixed(0)}¬∞`;
        } else {
          text += `\n‚Üñ Turn left ${Math.abs(diff).toFixed(0)}¬∞`;
        }

        document.getElementById("direction").textContent = text;
      }
    }
  </script>
</body>
</html>
