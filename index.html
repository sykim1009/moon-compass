<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🌙 달 위치 추적기</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    function useManualLocation() {
      const lat = parseFloat(document.getElementById('manualLat').value);
      const lon = parseFloat(document.getElementById('manualLon').value);
      
      if (isNaN(lat) || isNaN(lon) || Math.abs(lat) > 90 || Math.abs(lon) > 180) {
        alert('올바른 위도(-90~90)와 경도(-180~180)를 입력해주세요');
        return;
      }
      
      const now = new Date();
      const moon = moonPosition(now, lat, lon);
      currentMoonAzimuth = moon.azimuth;
      
      // 달 위상에 따른 이모지 업데이트
      const moonIcon = document.getElementById('moonIcon');
      moonIcon.textContent = getMoonPhaseEmoji(moon.phase);
      
      updateLocationDisplay();
      
      const status = document.getElementById('status');
      
      // 테스트 모드: 항상 나침반 활성화 (달 고도 무시)
      console.log(`테스트 모드: 달 고도 ${moon.altitude.toFixed(1)}° 무시하고 계속 진행`);
      status.textContent = '나침반을 활성화하는 중... (테스트 모드)';
      setupCompass();
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      font-size: 2em;
      margin-bottom: 30px;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
    }
    
    button {
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      margin-bottom: 20px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    #info {
      margin: 20px 0;
      font-size: 1.1em;
      line-height: 1.8;
      white-space: pre-line;
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 15px;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .moon-indicator {
      font-size: 4em;
      margin: 20px 0;
      transition: transform 0.3s ease;
    }
    
    .pointing {
      animation: pulse 1s infinite;
      color: #ffd700;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .status {
      font-size: 0.9em;
      opacity: 0.8;
      margin-top: 10px;
    }
    
    .coords {
      font-family: monospace;
      background: rgba(0, 0, 0, 0.3);
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
      margin: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🌙 달 위치 추적기</h1>
    <button id="startBtn" onclick="init()">위치 추적 시작</button>
    <div class="moon-indicator" id="moonIcon">🌙</div>
    <div id="info">위치 정보를 가져오는 중...</div>
    <div class="status" id="status">GPS와 나침반 권한이 필요합니다</div>
  </div>

  <script>
    let isTracking = false;
    
    function toJulian(date) {
      return date / 86400000 + 2440587.5;
    }
    
    function moonPosition(date, lat, lon) {
      const rad = Math.PI / 180;
      const day = toJulian(date) - 2451545.0;
      
      // 달의 평균 근사 궤도 요소 (더 정확한 계산)
      const L = (218.316 + 13.176396 * day) * rad; // 평균 황경
      const M = (134.963 + 13.064993 * day) * rad; // 평균 근점이각
      const F = (93.272 + 13.229350 * day) * rad;  // 평균 편각
      const D = (297.850 + 12.190749 * day) * rad; // 평균 이각
      
      // 더 정확한 황경/황위 계산 (주요 섭동 항 포함)
      let lonEcl = L + 6.289 * Math.sin(M) * rad;
      lonEcl += 1.274 * Math.sin(2*D - M) * rad; // 이차 섭동
      lonEcl += 0.658 * Math.sin(2*D) * rad;     // 타원 섭동
      lonEcl -= 0.186 * Math.sin(M) * rad;       // 연차 방정식
      
      const latEcl = 5.128 * Math.sin(F) * rad;
      
      // 황도 경사각
      const e = (23.439 - 0.0000004 * day) * rad;
      
      // 적경/적위 변환
      const ra = Math.atan2(
        Math.sin(lonEcl) * Math.cos(e) - Math.tan(latEcl) * Math.sin(e),
        Math.cos(lonEcl)
      );
      const dec = Math.asin(
        Math.sin(latEcl) * Math.cos(e) + Math.cos(latEcl) * Math.sin(e) * Math.sin(lonEcl)
      );
      
      // 그리니치 항성시 계산
      const GMST = (18.697374558 + 24.06570982441908 * day) % 24;
      const LST = (GMST * 15 + lon) * rad;
      const H = LST - ra; // 시간각
      
      // 지평 좌표계 변환
      const phi = lat * rad;
      const alt = Math.asin(
        Math.sin(phi) * Math.sin(dec) + Math.cos(phi) * Math.cos(dec) * Math.cos(H)
      );
      const az = Math.atan2(
        -Math.sin(H),
        Math.tan(dec) * Math.cos(phi) - Math.sin(phi) * Math.cos(H)
      );
      
      // 달의 위상 계산
      const phase = 0.5 * (1 - Math.cos(L - (282.9 + 0.3 * day) * rad));
      
      return {
        azimuth: (az / rad + 360) % 360,
        altitude: alt / rad,
        phase: phase
      };
    }
    
    function getMoonPhaseEmoji(phase) {
      if (phase < 0.1) return "🌑"; // 신월
      if (phase < 0.3) return "🌒"; // 초승달
      if (phase < 0.45) return "🌓"; // 상현달
      if (phase < 0.55) return "🌔"; // 보름달에 가까운
      if (phase < 0.7) return "🌕"; // 보름달
      if (phase < 0.8) return "🌖"; // 하현달에 가까운
      if (phase < 0.9) return "🌗"; // 하현달
      return "🌘"; // 그믐달
    }
    
    function init() {
      const startBtn = document.getElementById('startBtn');
      const status = document.getElementById('status');
      
      startBtn.disabled = true;
      startBtn.textContent = '위치 확인 중...';
      status.textContent = 'GPS 위치를 가져오는 중입니다...';
      
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const now = new Date();
            const moon = moonPosition(now, lat, lon);
            
            // 달 위상에 따른 이모지 업데이트
            const moonIcon = document.getElementById('moonIcon');
            moonIcon.textContent = getMoonPhaseEmoji(moon.phase);
            
            const info = document.getElementById('info');
            info.innerHTML = `
              <div>현재 위치</div>
              <div class="coords">${lat.toFixed(4)}°, ${lon.toFixed(4)}°</div>
              <div style="margin-top: 15px;">달의 위치</div>
              <div>방위각: <strong>${moon.azimuth.toFixed(1)}°</strong></div>
              <div>고도: <strong>${moon.altitude.toFixed(1)}°</strong></div>
              <div>위상: <strong>${(moon.phase * 100).toFixed(0)}%</strong></div>
            `;
            
            if (moon.altitude < 0) {
              status.textContent = '달이 지평선 아래에 있습니다';
              startBtn.textContent = '다시 확인';
              startBtn.disabled = false;
            } else {
              status.textContent = '나침반을 활성화하는 중...';
              setupCompass(moon.azimuth);
            }
          },
          error => {
            status.textContent = 'GPS 권한이 필요합니다';
            document.getElementById('info').textContent = '위치 정보를 가져올 수 없습니다.';
            startBtn.textContent = '다시 시도';
            startBtn.disabled = false;
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          }
        );
      } else {
        status.textContent = '이 브라우저는 위치 서비스를 지원하지 않습니다';
        startBtn.textContent = '다시 시도';
        startBtn.disabled = false;
      }
    }
    
    function setupCompass(moonAzimuth) {
      const status = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      
      if (typeof DeviceOrientationEvent !== 'undefined') {
        // iOS 13+ 권한 요청
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission()
            .then(response => {
              if (response === 'granted') {
                startCompassTracking(moonAzimuth);
              } else {
                status.textContent = '나침반 권한이 거부되었습니다';
                startBtn.textContent = '다시 시도';
                startBtn.disabled = false;
              }
            })
            .catch(err => {
              console.error(err);
              status.textContent = '나침반 권한 요청 실패';
              startBtn.textContent = '다시 시도';
              startBtn.disabled = false;
            });
        } else {
          // 안드로이드 등
          startCompassTracking(moonAzimuth);
        }
      } else {
        status.textContent = '이 기기는 나침반을 지원하지 않습니다';
        startBtn.textContent = '완료';
        startBtn.disabled = false;
      }
    }
    
    function startCompassTracking(moonAzimuth) {
      const status = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      const moonIcon = document.getElementById('moonIcon');
      
      isTracking = true;
      status.textContent = '달을 향해 기기를 돌려보세요!';
      startBtn.textContent = '추적 중지';
      startBtn.disabled = false;
      startBtn.onclick = stopTracking;
      
      function handleOrientation(event) {
        if (!isTracking) return;
        
        let heading = event.alpha;
        if (heading === null) return;
        
        // 안드로이드 보정
        if (event.webkitCompassHeading) {
          heading = event.webkitCompassHeading;
        } else {
          heading = 360 - heading;
        }
        
        const info = document.getElementById('info');
        const currentInfo = info.innerHTML.split('<div style="margin-top: 20px;">')[0];
        
        const diff = ((moonAzimuth - heading + 540) % 360) - 180;
        
        let directionInfo = `<div style="margin-top: 20px;">
          <div>현재 방향: <strong>${heading.toFixed(0)}°</strong></div>
          <div>달까지: <strong>${Math.abs(diff).toFixed(0)}°</strong></div>
        `;
        
        if (Math.abs(diff) < 10) {
          directionInfo += '<div style="color: #ffd700; font-size: 1.2em; margin-top: 10px;">🎯 달을 향하고 있습니다!</div>';
          moonIcon.className = 'pointing';
          status.textContent = '완벽합니다! 달을 찾으셨네요! ✨';
        } else {
          moonIcon.className = '';
          if (diff > 0) {
            directionInfo += '<div style="color: #87ceeb;">➡️ 오른쪽으로 돌리세요</div>';
            status.textContent = `오른쪽으로 ${Math.abs(diff).toFixed(0)}° 돌리세요`;
          } else {
            directionInfo += '<div style="color: #87ceeb;">⬅️ 왼쪽으로 돌리세요</div>';
            status.textContent = `왼쪽으로 ${Math.abs(diff).toFixed(0)}° 돌리세요`;
          }
        }
        
        directionInfo += '</div>';
        info.innerHTML = currentInfo + directionInfo;
      }
      
      // 다양한 이벤트 리스너 등록
      window.addEventListener('deviceorientationabsolute', handleOrientation, true);
      window.addEventListener('deviceorientation', handleOrientation, true);
    }
    
    function stopTracking() {
      isTracking = false;
      const startBtn = document.getElementById('startBtn');
      const status = document.getElementById('status');
      const moonIcon = document.getElementById('moonIcon');
      
      startBtn.textContent = '다시 시작';
      startBtn.onclick = init;
      status.textContent = '추적이 중지되었습니다';
      moonIcon.className = '';
      
      // 이벤트 리스너 제거
      window.removeEventListener('deviceorientationabsolute', () => {});
      window.removeEventListener('deviceorientation', () => {});
    }
  </script>
</body>
</html>
