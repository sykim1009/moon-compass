<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moon Locator</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: black;
      color: white;
      margin: 0;
      padding: 1em;
    }
    #direction {
      margin-top: 20px;
      font-size: 1.2em;
      line-height: 1.6;
      white-space: pre-line;
    }
    #compass, #altitudeDiagram {
      margin-top: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #map {
      margin-top: 20px;
      height: 300px;
      width: 300px;
      margin-left: auto;
      margin-right: auto;
    }
    @media (max-width: 600px) {
      #compass, #altitudeDiagram, #map {
        width: 90%;
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <h1>üåô Moon Locator</h1>
  <button onclick="init()">Start</button>
  <div id="direction">Waiting for data...</div>
  <canvas id="compass" width="300" height="300"></canvas>
  <div id="map"></div>
  <canvas id="altitudeDiagram" width="300" height="150"></canvas>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ============= Îã¨ Í≥ÑÏÇ∞Ïö© Ìï®ÏàòÎì§ =============
    function toJulian(date) {
      return date / 86400000 + 2440587.5;
    }

    function fromJulian(j) {
      return new Date((j - 2440587.5) * 86400000);
    }

    function moonPosition(date, lat, lon) {
      const rad = Math.PI / 180;
      const day = toJulian(date) - 2451545.0;

      const L = (218.316 + 13.176396 * day) * rad;
      const M = (134.963 + 13.064993 * day) * rad;
      const F = (93.272 + 13.229350 * day) * rad;

      const lonEcl = L + 6.289 * rad * Math.sin(M);
      const latEcl = 5.128 * rad * Math.sin(F);

      const e = (23.439 - 0.0000004 * day) * rad;

      const ra = Math.atan2(
        Math.sin(lonEcl) * Math.cos(e) - Math.tan(latEcl) * Math.sin(e),
        Math.cos(lonEcl)
      );
      const dec = Math.asin(
        Math.sin(latEcl) * Math.cos(e) + Math.cos(latEcl) * Math.sin(e) * Math.sin(lonEcl)
      );

      const GMST = (18.697374558 + 24.06570982441908 * day) % 24;
      const LST = (GMST * 15 + lon) * rad;

      const H = LST - ra;
      const phi = lat * rad;

      const alt = Math.asin(Math.sin(phi) * Math.sin(dec) + Math.cos(phi) * Math.cos(dec) * Math.cos(H));
      const az = Math.atan2(
        -Math.sin(H),
        Math.tan(dec) * Math.cos(phi) - Math.sin(phi) * Math.cos(H)
      );

      // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
      console.log(`moonPosition: Date=${date.toISOString()}, Lat=${lat}, Lon=${lon}, Alt=${(alt / rad).toFixed(2)}¬∞, Az=${((az / rad + 360) % 360).toFixed(2)}¬∞, Dec=${(dec / rad).toFixed(2)}¬∞, RA=${(ra / rad).toFixed(2)}¬∞`);

      return {
        azimuth: (az / rad + 360) % 360,
        altitude: alt / rad,
        dec: dec,
        ra: ra
      };
    }

    function getMoonPhase(date) {
      const lp = 2551442.88; // ÌèâÍ∑† ÏÇ≠ÎßùÏõî (Ï¥à, ÏïΩ 29.530588Ïùº)
      const newMoon = new Date(Date.UTC(2020, 0, 21, 10, 14)); // 2020ÎÖÑ 1Ïõî 21Ïùº 10:14 UTC
      const phase = ((date.getTime() - newMoon.getTime()) / 1000) % lp;
      const phaseFraction = phase / lp;
      console.log(`Moon Phase: ${phaseFraction.toFixed(4)}`);
      return phaseFraction;
    }

    function getMoonPhaseEmoji(phase) {
      if (phase < 0.05 || phase >= 0.95) return "üåë"; // Ïã†Ïõî
      if (phase < 0.25) return "üåí"; // ÏÉÅÌòÑÎã¨
      if (phase < 0.45) return "üåì"; // ÏÉÅÌòÑÎã¨ (1/4)
      if (phase < 0.55) return "üåî"; // ÏÉÅÌòÑÎã¨ (3/4)
      if (phase < 0.75) return "üåï"; // Î≥¥Î¶ÑÎã¨
      if (phase < 0.85) return "üåñ"; // ÌïòÌòÑÎã¨ (3/4)
      if (phase < 0.95) return "üåó"; // ÌïòÌòÑÎã¨ (1/4)
      return "üåò"; // ÌïòÌòÑÎã¨
    }

    function moonRiseSet(date, lat, lon) {
      const rad = Math.PI / 180;
      const h0 = -0.833 * rad; // Îã¨ Î∞òÏßÄÎ¶Ñ(0.25¬∞) + ÎåÄÍ∏∞ Íµ¥Ï†à(0.34¬∞) + ÏßÄÌèâÏÑ† Î≥¥Ï†ï
      const phi = lat * rad;
      const lw = -lon * rad;

      const d = toJulian(date) - 2451545.0;

      const times = {};
      let riseTime = null;
      let setTime = null;

      // 1Î∂Ñ Í∞ÑÍ≤©(1/1440)ÏúºÎ°ú ÌôïÏù∏
      for (let i = 0; i < 1440; i++) {
        const currentTime = fromJulian(toJulian(date) + i / 1440);
        const nextTime = fromJulian(toJulian(date) + (i + 1) / 1440);
        
        const mp1 = moonPosition(currentTime, lat, lon);
        const mp2 = moonPosition(nextTime, lat, lon);

        const GMST1 = (18.697374558 + 24.06570982441908 * (toJulian(currentTime) - 2451545.0)) % 24;
        const LST1 = (GMST1 * 15 + lon) * rad;
        const H1 = LST1 - mp1.ra;

        const GMST2 = (18.697374558 + 24.06570982441908 * (toJulian(nextTime) - 2451545.0)) % 24;
        const LST2 = (GMST2 * 15 + lon) * rad;
        const H2 = LST2 - mp2.ra;

        const alt1 = Math.asin(Math.sin(phi) * Math.sin(mp1.dec) + Math.cos(phi) * Math.cos(mp1.dec) * Math.cos(H1));
        const alt2 = Math.asin(Math.sin(phi) * Math.sin(mp2.dec) + Math.cos(phi) * Math.cos(mp2.dec) * Math.cos(H2));

        // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏ (10Î∂ÑÎßàÎã§ Ï∂úÎ†•)
        if (i % 10 === 0) {
          console.log(`moonRiseSet: Time=${currentTime.toISOString()}, Alt1=${(alt1 / rad).toFixed(2)}¬∞, Alt2=${(alt2 / rad).toFixed(2)}¬∞, H1=${(H1 / rad).toFixed(2)}¬∞, h0=${(h0 / rad).toFixed(3)}¬∞`);
        }

        if (alt1 <= h0 && alt2 > h0) {
          const fraction = (h0 - alt1) / (alt2 - alt1);
          riseTime = new Date(currentTime.getTime() + fraction * (60 * 1000)); // 1Î∂Ñ Í∞ÑÍ≤©
          console.log(`Rise detected at ${riseTime.toISOString()} (KST: ${riseTime.toLocaleString('en-US', { timeZone: 'Asia/Seoul' })})`);
        } else if (alt1 >= h0 && alt2 < h0) {
          const fraction = (h0 - alt1) / (alt2 - alt1);
          setTime = new Date(currentTime.getTime() + fraction * (60 * 1000)); // 1Î∂Ñ Í∞ÑÍ≤©
          console.log(`Set detected at ${setTime.toISOString()} (KST: ${setTime.toLocaleString('en-US', { timeZone: 'Asia/Seoul' })})`);
        }
      }

      // Í∑πÏßÄÎ∞© Ï≤òÎ¶¨
      if (!riseTime && !setTime) {
        const mp = moonPosition(date, lat, lon);
        if (mp.altitude > 0) {
          console.log("Moon is always above horizon");
          times.status = "Moon is always above horizon";
        } else {
          console.log("Moon is always below horizon");
          times.status = "Moon is always below horizon";
        }
      }

      if (riseTime) times.rise = riseTime;
      if (setTime) times.set = setTime;

      return times;
    }

    // ============= Î©îÏù∏ Î°úÏßÅ =============
    let moonData = null;
    let updateTimer = null;
    let map = null;
    let marker = null;

    function init() {
      if (navigator.geolocation) {
        if (updateTimer) {
          clearInterval(updateTimer);
          updateTimer = null;
        }

        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          if (!map) {
            map = L.map('map').setView([lat, lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            marker = L.marker([lat, lon]).addTo(map)
              .bindPopup('Your Location').openPopup();
          } else {
            map.setView([lat, lon], 13);
            marker.setLatLng([lat, lon]);
          }

          function update() {
            const now = new Date();
            const utcNow = new Date(Date.UTC(
              now.getUTCFullYear(),
              now.getUTCMonth(),
              now.getUTCDate(),
              now.getUTCHours(),
              now.getUTCMinutes(),
              now.getUTCSeconds()
            ));
            const moon = moonPosition(utcNow, lat, lon);
            const phase = getMoonPhase(utcNow);
            const emoji = getMoonPhaseEmoji(phase);
            const times = moonRiseSet(utcNow, lat, lon);

            let text =
              `Your position: ${lat.toFixed(4)}, ${lon.toFixed(4)}\n` +
              `Moon ‚Üí ${emoji} (Phase: ${phase.toFixed(2)})\n` +
              `Azimuth: ${moon.azimuth.toFixed(1)}¬∞, Altitude: ${moon.altitude.toFixed(1)}¬∞\n`;

            if (times.rise && times.set) {
              text += `Rise: ${times.rise.toLocaleTimeString('en-US', { timeZone: 'Asia/Seoul' })}\n` +
                      `Set: ${times.set.toLocaleTimeString('en-US', { timeZone: 'Asia/Seoul' })}`;
            } else {
              text += `Rise/Set: ${times.status || 'N/A'}`;
            }

            document.getElementById("direction").textContent = text;
            moonData = moon;

            // Îã§Ïù¥Ïñ¥Í∑∏Îû® ÏóÖÎç∞Ïù¥Ìä∏
            updateAltitudeDiagram(moon.azimuth, moon.altitude);
          }

          update();
          updateTimer = setInterval(update, 500);

          if (!window.ondeviceorientationabsolute && !window.ondeviceorientation) {
            setupCompass();
          }
        }, () => {
          alert("Geolocation failed");
        });
      } else {
        alert("Geolocation not supported");
      }
    }

    function setupCompass() {
      if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === "granted") {
              window.addEventListener("deviceorientation", debouncedUpdateHeading, true);
            } else {
              alert("Device orientation permission denied");
            }
          })
          .catch(() => alert("Device orientation not supported"));
      } else if (window.DeviceOrientationEvent) {
        window.addEventListener("deviceorientationabsolute", debouncedUpdateHeading, true);
      } else {
        alert("Device orientation not supported");
      }
    }

    function updateHeading(e) {
      if (!moonData || e.alpha == null) return;

      const heading = 360 - e.alpha;
      const canvas = document.getElementById("compass");
      const ctx = canvas.getContext("2d");
      const radius = canvas.width / 2;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.beginPath();
      ctx.arc(radius, radius, radius - 10, 0, 2 * Math.PI);
      ctx.fillStyle = "#333";
      ctx.fill();
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.fillStyle = "#fff";
      ctx.font = "16px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("N", radius, 20);
      ctx.fillText("E", canvas.width - 20, radius);
      ctx.fillText("S", radius, canvas.height - 20);
      ctx.fillText("W", 20, radius);

      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(heading * Math.PI / 180);
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.moveTo(0, -radius + 20);
      ctx.lineTo(-10, -radius + 40);
      ctx.lineTo(10, -radius + 40);
      ctx.closePath();
      ctx.fill();
      ctx.restore();

      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(moonData.azimuth * Math.PI / 180);
      ctx.font = "24px sans-serif";
      ctx.fillStyle = "yellow";
      ctx.fillText("üåô", 0, -radius + 30);
      ctx.restore();
    }

    function updateAltitudeDiagram(azimuth, altitude) {
      const canvas = document.getElementById("altitudeDiagram");
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;
      const centerX = width / 2;
      const centerY = height - 20;

      // Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî
      ctx.clearRect(0, 0, width, height);

      // ÏßÄÌèâÏÑ† Í∑∏Î¶¨Í∏∞
      ctx.beginPath();
      ctx.moveTo(0, centerY);
      ctx.lineTo(width, centerY);
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.stroke();

      // Í≥†ÎèÑ(-90¬∞~90¬∞) ÌëúÏãú
      ctx.fillStyle = "#fff";
      ctx.font = "12px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("90¬∞", centerX, 20);
      ctx.fillText("0¬∞", centerX, centerY);
      ctx.fillText("-90¬∞", centerX, height - 20);

      // Îã¨Ïùò Í≥†ÎèÑ ÌëúÏãú
      const maxAltitude = 90; // Í≥†ÎèÑ Î≤îÏúÑ: -90¬∞~90¬∞
      const y = centerY - (altitude / maxAltitude) * (centerY - 20); // Í≥†ÎèÑÎ•º Ï∫îÎ≤ÑÏä§ Y Ï¢åÌëúÎ°ú Îß§Ìïë
      ctx.beginPath();
      ctx.arc(centerX, y, 10, 0, 2 * Math.PI);
      ctx.fillStyle = "yellow";
      ctx.fill();

      // Î∞©ÏúÑÍ∞Å ÌëúÏãú (ÌÖçÏä§Ìä∏Î°ú Ï∂îÍ∞Ä)
      ctx.fillStyle = "#fff";
      ctx.font = "14px sans-serif";
      ctx.fillText(`Azimuth: ${azimuth.toFixed(1)}¬∞`, centerX, height - 10);
    }

    let lastHeadingUpdate = 0;
    function debouncedUpdateHeading(e) {
      const now = performance.now();
      if (now - lastHeadingUpdate < 100) return;
      lastHeadingUpdate = now;
      requestAnimationFrame(() => updateHeading(e));
    }
  </script>
</body>
</html>