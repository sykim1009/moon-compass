<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ™ ë‹¬ ìœ„ì¹˜ ì¶”ì ê¸°</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    function useManualLocation() {
      const lat = parseFloat(document.getElementById('manualLat').value);
      const lon = parseFloat(document.getElementById('manualLon').value);
      
      if (isNaN(lat) || isNaN(lon) || Math.abs(lat) > 90 || Math.abs(lon) > 180) {
        alert('ì˜¬ë°”ë¥¸ ìœ„ë„(-90~90)ì™€ ê²½ë„(-180~180)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      const now = new Date();
      const moon = moonPosition(now, lat, lon);
      currentMoonAzimuth = moon.azimuth;
      
      // ë‹¬ ìœ„ìƒì— ë”°ë¥¸ ì´ëª¨ì§€ ì—…ë°ì´íŠ¸
      const moonIcon = document.getElementById('moonIcon');
      moonIcon.textContent = getMoonPhaseEmoji(moon.phase);
      
      updateLocationDisplay();
      
      const status = document.getElementById('status');
      
      // í…ŒìŠ¤íŠ¸ ëª¨ë“œ: í•­ìƒ ë‚˜ì¹¨ë°˜ í™œì„±í™” (ë‹¬ ê³ ë„ ë¬´ì‹œ)
      console.log(`í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë‹¬ ê³ ë„ ${moon.altitude.toFixed(1)}Â° ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰`);
      status.textContent = 'ë‚˜ì¹¨ë°˜ì„ í™œì„±í™”í•˜ëŠ” ì¤‘... (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)';
      setupCompass();
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      font-size: 2em;
      margin-bottom: 30px;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
    }
    
    button {
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      margin-bottom: 20px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    #info {
      margin: 20px 0;
      font-size: 1.1em;
      line-height: 1.8;
      white-space: pre-line;
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 15px;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .moon-indicator {
      font-size: 4em;
      margin: 20px 0;
      transition: transform 0.3s ease;
    }
    
    .pointing {
      animation: pulse 1s infinite;
      color: #ffd700;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .status {
      font-size: 0.9em;
      opacity: 0.8;
      margin-top: 10px;
    }
    
    .coords {
      font-family: monospace;
      background: rgba(0, 0, 0, 0.3);
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
      margin: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ™ ë‹¬ ìœ„ì¹˜ ì¶”ì ê¸°</h1>
    <button id="startBtn" onclick="init()">ìœ„ì¹˜ ì¶”ì  ì‹œì‘</button>
    <div class="moon-indicator" id="moonIcon">ğŸŒ™</div>
    <div id="info">ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>
    <div class="status" id="status">GPSì™€ ë‚˜ì¹¨ë°˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</div>
  </div>

  <script>
    let isTracking = false;
    
    function toJulian(date) {
      return date / 86400000 + 2440587.5;
    }
    
    function moonPosition(date, lat, lon) {
      const rad = Math.PI / 180;
      const day = toJulian(date) - 2451545.0;
      
      // ë‹¬ì˜ í‰ê·  ê·¼ì‚¬ ê¶¤ë„ ìš”ì†Œ (ë” ì •í™•í•œ ê³„ì‚°)
      const L = (218.316 + 13.176396 * day) * rad; // í‰ê·  í™©ê²½
      const M = (134.963 + 13.064993 * day) * rad; // í‰ê·  ê·¼ì ì´ê°
      const F = (93.272 + 13.229350 * day) * rad;  // í‰ê·  í¸ê°
      const D = (297.850 + 12.190749 * day) * rad; // í‰ê·  ì´ê°
      
      // ë” ì •í™•í•œ í™©ê²½/í™©ìœ„ ê³„ì‚° (ì£¼ìš” ì„­ë™ í•­ í¬í•¨)
      let lonEcl = L + 6.289 * Math.sin(M) * rad;
      lonEcl += 1.274 * Math.sin(2*D - M) * rad; // ì´ì°¨ ì„­ë™
      lonEcl += 0.658 * Math.sin(2*D) * rad;     // íƒ€ì› ì„­ë™
      lonEcl -= 0.186 * Math.sin(M) * rad;       // ì—°ì°¨ ë°©ì •ì‹
      
      const latEcl = 5.128 * Math.sin(F) * rad;
      
      // í™©ë„ ê²½ì‚¬ê°
      const e = (23.439 - 0.0000004 * day) * rad;
      
      // ì ê²½/ì ìœ„ ë³€í™˜
      const ra = Math.atan2(
        Math.sin(lonEcl) * Math.cos(e) - Math.tan(latEcl) * Math.sin(e),
        Math.cos(lonEcl)
      );
      const dec = Math.asin(
        Math.sin(latEcl) * Math.cos(e) + Math.cos(latEcl) * Math.sin(e) * Math.sin(lonEcl)
      );
      
      // ê·¸ë¦¬ë‹ˆì¹˜ í•­ì„±ì‹œ ê³„ì‚°
      const GMST = (18.697374558 + 24.06570982441908 * day) % 24;
      const LST = (GMST * 15 + lon) * rad;
      const H = LST - ra; // ì‹œê°„ê°
      
      // ì§€í‰ ì¢Œí‘œê³„ ë³€í™˜
      const phi = lat * rad;
      const alt = Math.asin(
        Math.sin(phi) * Math.sin(dec) + Math.cos(phi) * Math.cos(dec) * Math.cos(H)
      );
      const az = Math.atan2(
        -Math.sin(H),
        Math.tan(dec) * Math.cos(phi) - Math.sin(phi) * Math.cos(H)
      );
      
      // ë‹¬ì˜ ìœ„ìƒ ê³„ì‚°
      const phase = 0.5 * (1 - Math.cos(L - (282.9 + 0.3 * day) * rad));
      
      return {
        azimuth: (az / rad + 360) % 360,
        altitude: alt / rad,
        phase: phase
      };
    }
    
    function getMoonPhaseEmoji(phase) {
      if (phase < 0.1) return "ğŸŒ‘"; // ì‹ ì›”
      if (phase < 0.3) return "ğŸŒ’"; // ì´ˆìŠ¹ë‹¬
      if (phase < 0.45) return "ğŸŒ“"; // ìƒí˜„ë‹¬
      if (phase < 0.55) return "ğŸŒ”"; // ë³´ë¦„ë‹¬ì— ê°€ê¹Œìš´
      if (phase < 0.7) return "ğŸŒ•"; // ë³´ë¦„ë‹¬
      if (phase < 0.8) return "ğŸŒ–"; // í•˜í˜„ë‹¬ì— ê°€ê¹Œìš´
      if (phase < 0.9) return "ğŸŒ—"; // í•˜í˜„ë‹¬
      return "ğŸŒ˜"; // ê·¸ë¯ë‹¬
    }
    
    function init() {
      const startBtn = document.getElementById('startBtn');
      const status = document.getElementById('status');
      
      startBtn.disabled = true;
      startBtn.textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
      status.textContent = 'GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
      
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const now = new Date();
            const moon = moonPosition(now, lat, lon);
            
            // ë‹¬ ìœ„ìƒì— ë”°ë¥¸ ì´ëª¨ì§€ ì—…ë°ì´íŠ¸
            const moonIcon = document.getElementById('moonIcon');
            moonIcon.textContent = getMoonPhaseEmoji(moon.phase);
            
            const info = document.getElementById('info');
            info.innerHTML = `
              <div>í˜„ì¬ ìœ„ì¹˜</div>
              <div class="coords">${lat.toFixed(4)}Â°, ${lon.toFixed(4)}Â°</div>
              <div style="margin-top: 15px;">ë‹¬ì˜ ìœ„ì¹˜</div>
              <div>ë°©ìœ„ê°: <strong>${moon.azimuth.toFixed(1)}Â°</strong></div>
              <div>ê³ ë„: <strong>${moon.altitude.toFixed(1)}Â°</strong></div>
              <div>ìœ„ìƒ: <strong>${(moon.phase * 100).toFixed(0)}%</strong></div>
            `;
            
            if (moon.altitude < 0) {
              status.textContent = 'ë‹¬ì´ ì§€í‰ì„  ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤';
              startBtn.textContent = 'ë‹¤ì‹œ í™•ì¸';
              startBtn.disabled = false;
            } else {
              status.textContent = 'ë‚˜ì¹¨ë°˜ì„ í™œì„±í™”í•˜ëŠ” ì¤‘...';
              setupCompass(moon.azimuth);
            }
          },
          error => {
            status.textContent = 'GPS ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
            document.getElementById('info').textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            startBtn.textContent = 'ë‹¤ì‹œ ì‹œë„';
            startBtn.disabled = false;
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          }
        );
      } else {
        status.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
        startBtn.textContent = 'ë‹¤ì‹œ ì‹œë„';
        startBtn.disabled = false;
      }
    }
    
    function setupCompass(moonAzimuth) {
      const status = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      
      if (typeof DeviceOrientationEvent !== 'undefined') {
        // iOS 13+ ê¶Œí•œ ìš”ì²­
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission()
            .then(response => {
              if (response === 'granted') {
                startCompassTracking(moonAzimuth);
              } else {
                status.textContent = 'ë‚˜ì¹¨ë°˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤';
                startBtn.textContent = 'ë‹¤ì‹œ ì‹œë„';
                startBtn.disabled = false;
              }
            })
            .catch(err => {
              console.error(err);
              status.textContent = 'ë‚˜ì¹¨ë°˜ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨';
              startBtn.textContent = 'ë‹¤ì‹œ ì‹œë„';
              startBtn.disabled = false;
            });
        } else {
          // ì•ˆë“œë¡œì´ë“œ ë“±
          startCompassTracking(moonAzimuth);
        }
      } else {
        status.textContent = 'ì´ ê¸°ê¸°ëŠ” ë‚˜ì¹¨ë°˜ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
        startBtn.textContent = 'ì™„ë£Œ';
        startBtn.disabled = false;
      }
    }
    
    function startCompassTracking(moonAzimuth) {
      const status = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      const moonIcon = document.getElementById('moonIcon');
      
      isTracking = true;
      status.textContent = 'ë‹¬ì„ í–¥í•´ ê¸°ê¸°ë¥¼ ëŒë ¤ë³´ì„¸ìš”!';
      startBtn.textContent = 'ì¶”ì  ì¤‘ì§€';
      startBtn.disabled = false;
      startBtn.onclick = stopTracking;
      
      function handleOrientation(event) {
        if (!isTracking) return;
        
        let heading = event.alpha;
        if (heading === null) return;
        
        // ì•ˆë“œë¡œì´ë“œ ë³´ì •
        if (event.webkitCompassHeading) {
          heading = event.webkitCompassHeading;
        } else {
          heading = 360 - heading;
        }
        
        const info = document.getElementById('info');
        const currentInfo = info.innerHTML.split('<div style="margin-top: 20px;">')[0];
        
        const diff = ((moonAzimuth - heading + 540) % 360) - 180;
        
        let directionInfo = `<div style="margin-top: 20px;">
          <div>í˜„ì¬ ë°©í–¥: <strong>${heading.toFixed(0)}Â°</strong></div>
          <div>ë‹¬ê¹Œì§€: <strong>${Math.abs(diff).toFixed(0)}Â°</strong></div>
        `;
        
        if (Math.abs(diff) < 10) {
          directionInfo += '<div style="color: #ffd700; font-size: 1.2em; margin-top: 10px;">ğŸ¯ ë‹¬ì„ í–¥í•˜ê³  ìˆìŠµë‹ˆë‹¤!</div>';
          moonIcon.className = 'pointing';
          status.textContent = 'ì™„ë²½í•©ë‹ˆë‹¤! ë‹¬ì„ ì°¾ìœ¼ì…¨ë„¤ìš”! âœ¨';
        } else {
          moonIcon.className = '';
          if (diff > 0) {
            directionInfo += '<div style="color: #87ceeb;">â¡ï¸ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ëŒë¦¬ì„¸ìš”</div>';
            status.textContent = `ì˜¤ë¥¸ìª½ìœ¼ë¡œ ${Math.abs(diff).toFixed(0)}Â° ëŒë¦¬ì„¸ìš”`;
          } else {
            directionInfo += '<div style="color: #87ceeb;">â¬…ï¸ ì™¼ìª½ìœ¼ë¡œ ëŒë¦¬ì„¸ìš”</div>';
            status.textContent = `ì™¼ìª½ìœ¼ë¡œ ${Math.abs(diff).toFixed(0)}Â° ëŒë¦¬ì„¸ìš”`;
          }
        }
        
        directionInfo += '</div>';
        info.innerHTML = currentInfo + directionInfo;
      }
      
      // ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      window.addEventListener('deviceorientationabsolute', handleOrientation, true);
      window.addEventListener('deviceorientation', handleOrientation, true);
    }
    
    function stopTracking() {
      isTracking = false;
      const startBtn = document.getElementById('startBtn');
      const status = document.getElementById('status');
      const moonIcon = document.getElementById('moonIcon');
      
      startBtn.textContent = 'ë‹¤ì‹œ ì‹œì‘';
      startBtn.onclick = init;
      status.textContent = 'ì¶”ì ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤';
      moonIcon.className = '';
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
      window.removeEventListener('deviceorientationabsolute', () => {});
      window.removeEventListener('deviceorientation', () => {});
    }
  </script>
</body>
</html>
