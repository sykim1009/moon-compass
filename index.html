<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ™ ë‹¬ ìœ„ì¹˜ ì¶”ì ê¸°</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 140px; /* í•˜ë‹¨ ë²„ì „ íŒ¨ë„ ê³µê°„ */
    }
    
    h1 {
      font-size: 2em;
      margin-bottom: 20px;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
    }
    
    .test-mode-section {
      margin-bottom: 25px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    button {
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      margin: 5px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    #testModeBtn {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      padding: 10px 20px;
      font-size: 14px;
      margin: 0;
    }
    
    #testModeBtn.production {
      background: linear-gradient(45deg, #00d2d3, #54a0ff);
    }
    
    #info {
      margin: 20px 0;
      font-size: 1.1em;
      line-height: 1.8;
      white-space: pre-line;
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 15px;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .moon-indicator {
      font-size: 4em;
      margin: 20px 0;
      transition: transform 0.3s ease;
    }
    
    .pointing {
      animation: pulse 1s infinite;
      color: #ffd700;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .status {
      font-size: 0.9em;
      opacity: 0.8;
      margin-top: 10px;
    }
    
    .coords {
      font-family: monospace;
      background: rgba(0, 0, 0, 0.3);
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
      margin: 5px;
    }
    
    /* ë²„ì „ ì„ íƒ íŒ¨ë„ */
    .version-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(15px);
      padding: 20px;
      text-align: center;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
    }
    
    .version-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 15px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
      min-width: 50px;
      margin: 0 5px;
    }
    
    .version-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .version-btn.active {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-color: #667eea;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4);
    }
    
    .version-info {
      font-size: 0.8em;
      color: #ccc;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ™ ë‹¬ ìœ„ì¹˜ ì¶”ì ê¸°</h1>
    
    <!-- í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì„¹ì…˜ -->
    <div class="test-mode-section">
      <button id="testModeBtn" onclick="toggleTestMode()">
        ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ON
      </button>
      <div style="font-size: 0.8em; color: #ccc; margin-top: 8px;">
        í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë‹¬ ê³ ë„ ì²´í¬ ë¬´ì‹œ (í•­ìƒ ì‘ë™)
      </div>
    </div>
    
    <button id="startBtn" onclick="init()">ìœ„ì¹˜ ì¶”ì  ì‹œì‘</button>
    <div class="moon-indicator" id="moonIcon">ğŸŒ™</div>
    <div id="info">ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>
    <div class="status" id="status">GPSì™€ ë‚˜ì¹¨ë°˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</div>
  </div>

  <!-- ë²„ì „ ì„ íƒ íŒ¨ë„ -->
  <div class="version-panel">
    <div style="margin-bottom: 15px; font-size: 1em; color: #fff;">
      ğŸš€ Moon Tracker Versions
    </div>
    <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
      <button onclick="loadVersion(1)" class="version-btn" data-version="1">v1.0</button>
      <button onclick="loadVersion(2)" class="version-btn" data-version="2">v2.0</button>
      <button onclick="loadVersion(3)" class="version-btn" data-version="3">v3.0</button>
      <button onclick="loadVersion(4)" class="version-btn" data-version="4">v4.0</button>
      <button onclick="loadVersion(5)" class="version-btn" data-version="5">v5.0</button>
      <button onclick="loadVersion(6)" class="version-btn active" data-version="6">v6.0</button>
    </div>
    <div class="version-info" id="versionInfo">
      í˜„ì¬: v6.0 - 0.1ì´ˆ ê³ ì† ì‹¤ì‹œê°„ ì¶”ì  + í…ŒìŠ¤íŠ¸ ëª¨ë“œ
    </div>
  </div>

  <script>
    let isTracking = false;
    let watchId = null;
    let updateInterval = null;
    let currentMoonAzimuth = 0;
    let currentHeading = 0;
    let currentLat = 0;
    let currentLon = 0;
    let currentAccuracy = 0;
    let testMode = true; // ê¸°ë³¸ê°’: í…ŒìŠ¤íŠ¸ ëª¨ë“œ í™œì„±í™”
    
    function toJulian(date) {
      return date / 86400000 + 2440587.5;
    }
    
    function moonPosition(date, lat, lon) {
      const rad = Math.PI / 180;
      const day = toJulian(date) - 2451545.0;
      
      // ë‹¬ì˜ í‰ê·  ê·¼ì‚¬ ê¶¤ë„ ìš”ì†Œ
      const L = (218.316 + 13.176396 * day) * rad; // í‰ê·  í™©ê²½
      const M = (134.963 + 13.064993 * day) * rad; // í‰ê·  ê·¼ì ì´ê°
      const F = (93.272 + 13.229350 * day) * rad;  // í‰ê·  í¸ê°
      const D = (297.850 + 12.190749 * day) * rad; // í‰ê·  ì´ê°
      
      // ë” ì •í™•í•œ í™©ê²½/í™©ìœ„ ê³„ì‚°
      let lonEcl = L + 6.289 * Math.sin(M) * rad;
      lonEcl += 1.274 * Math.sin(2*D - M) * rad;
      lonEcl += 0.658 * Math.sin(2*D) * rad;
      lonEcl -= 0.186 * Math.sin(M) * rad;
      
      const latEcl = 5.128 * Math.sin(F) * rad;
      
      // í™©ë„ ê²½ì‚¬ê°
      const e = (23.439 - 0.0000004 * day) * rad;
      
      // ì ê²½/ì ìœ„ ë³€í™˜
      const ra = Math.atan2(
        Math.sin(lonEcl) * Math.cos(e) - Math.tan(latEcl) * Math.sin(e),
        Math.cos(lonEcl)
      );
      const dec = Math.asin(
        Math.sin(latEcl) * Math.cos(e) + Math.cos(latEcl) * Math.sin(e) * Math.sin(lonEcl)
      );
      
      // ê·¸ë¦¬ë‹ˆì¹˜ í•­ì„±ì‹œ ê³„ì‚°
      const GMST = (18.697374558 + 24.06570982441908 * day) % 24;
      const LST = (GMST * 15 + lon) * rad;
      const H = LST - ra;
      
      // ì§€í‰ ì¢Œí‘œê³„ ë³€í™˜
      const phi = lat * rad;
      const alt = Math.asin(
        Math.sin(phi) * Math.sin(dec) + Math.cos(phi) * Math.cos(dec) * Math.cos(H)
      );
      const az = Math.atan2(
        -Math.sin(H),
        Math.tan(dec) * Math.cos(phi) - Math.sin(phi) * Math.cos(H)
      );
      
      // ë‹¬ì˜ ìœ„ìƒ ê³„ì‚°
      const phase = 0.5 * (1 - Math.cos(L - (282.9 + 0.3 * day) * rad));
      
      return {
        azimuth: (az / rad + 360) % 360,
        altitude: alt / rad,
        phase: phase
      };
    }
    
    function getMoonPhaseEmoji(phase) {
      if (phase < 0.1) return "ğŸŒ‘"; // ì‹ ì›”
      if (phase < 0.3) return "ğŸŒ’"; // ì´ˆìŠ¹ë‹¬
      if (phase < 0.45) return "ğŸŒ“"; // ìƒí˜„ë‹¬
      if (phase < 0.55) return "ğŸŒ”"; // ë³´ë¦„ë‹¬ì— ê°€ê¹Œìš´
      if (phase < 0.7) return "ğŸŒ•"; // ë³´ë¦„ë‹¬
      if (phase < 0.8) return "ğŸŒ–"; // í•˜í˜„ë‹¬ì— ê°€ê¹Œìš´
      if (phase < 0.9) return "ğŸŒ—"; // í•˜í˜„ë‹¬
      return "ğŸŒ˜"; // ê·¸ë¯ë‹¬
    }
    
    function toggleTestMode() {
      testMode = !testMode;
      const btn = document.getElementById('testModeBtn');
      
      if (testMode) {
        btn.textContent = 'ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ON';
        btn.className = '';
        document.querySelector('.test-mode-section div').textContent = 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë‹¬ ê³ ë„ ì²´í¬ ë¬´ì‹œ (í•­ìƒ ì‘ë™)';
      } else {
        btn.textContent = 'ğŸš€ ìš´ì˜ ëª¨ë“œ: ON';
        btn.className = 'production';
        document.querySelector('.test-mode-section div').textContent = 'ìš´ì˜ ëª¨ë“œ: ë‹¬ì´ ì§€í‰ì„  ì•„ë˜ë©´ ì¶”ì  ì¤‘ë‹¨';
      }
      
      console.log(`ëª¨ë“œ ë³€ê²½: ${testMode ? 'í…ŒìŠ¤íŠ¸' : 'ìš´ì˜'} ëª¨ë“œ í™œì„±í™”`);
      
      // ì¶”ì  ì¤‘ì´ë©´ ì¬ì‹œì‘
      if (isTracking) {
        stopTracking();
        setTimeout(() => init(), 500);
      }
    }
    
    function init() {
      const startBtn = document.getElementById('startBtn');
      const status = document.getElementById('status');
      
      // ë¸Œë¼ìš°ì € ê°ì§€
      const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
      const isFirefox = /Firefox/.test(navigator.userAgent);
      
      startBtn.disabled = true;
      startBtn.textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
      
      if (isChrome) {
        status.textContent = 'Chromeì—ì„œ GPS ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘... (ê¶Œí•œ íŒì—… í™•ì¸)';
      } else if (isFirefox) {
        status.textContent = 'Firefoxì—ì„œ GPS ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...';
      } else {
        status.textContent = 'GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
      }
      
      if (navigator.geolocation) {
        // ê¶Œí•œ ìƒíƒœ í™•ì¸
        if (navigator.permissions) {
          navigator.permissions.query({name: 'geolocation'}).then(result => {
            console.log('ìœ„ì¹˜ ê¶Œí•œ ìƒíƒœ:', result.state);
          });
        }
        
        // ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ì‹œì‘
        watchId = navigator.geolocation.watchPosition(
          position => {
            currentLat = position.coords.latitude;
            currentLon = position.coords.longitude;
            currentAccuracy = position.coords.accuracy || 0;
            
            // ë‹¬ ìœ„ì¹˜ ê³„ì‚°
            const now = new Date();
            const moon = moonPosition(now, currentLat, currentLon);
            currentMoonAzimuth = moon.azimuth;
            
            // ë‹¬ ìœ„ìƒì— ë”°ë¥¸ ì´ëª¨ì§€ ì—…ë°ì´íŠ¸
            const moonIcon = document.getElementById('moonIcon');
            moonIcon.textContent = getMoonPhaseEmoji(moon.phase);
            
            // í…ŒìŠ¤íŠ¸ ëª¨ë“œì— ë”°ë¥¸ ë‹¬ ê³ ë„ ì²´í¬
            if (!testMode && moon.altitude < 0) {
              status.textContent = 'ë‹¬ì´ ì§€í‰ì„  ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤ (ìš´ì˜ ëª¨ë“œ)';
              startBtn.textContent = 'ì¶”ì  ì¤‘ì§€';
              startBtn.onclick = stopTracking;
              startBtn.disabled = false;
              console.log(`ìš´ì˜ ëª¨ë“œ: ë‹¬ ê³ ë„ ${moon.altitude.toFixed(1)}Â° - ì¶”ì  ì¤‘ë‹¨`);
              document.getElementById('info').innerHTML = `
                <div style="color: #ff6b6b; text-align: center;">
                  âŒ ë‹¬ì´ ì§€í‰ì„  ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤<br>
                  <small>ê³ ë„: ${moon.altitude.toFixed(1)}Â°</small><br><br>
                  <small>ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì „í™˜í•˜ê±°ë‚˜<br>ë‹¬ì´ ë– ì˜¤ë¥¼ ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</small>
                </div>
              `;
              return;
            } else {
              if (testMode) {
                console.log(`í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë‹¬ ê³ ë„ ${moon.altitude.toFixed(1)}Â° ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰`);
              } else {
                console.log(`ìš´ì˜ ëª¨ë“œ: ë‹¬ ê³ ë„ ${moon.altitude.toFixed(1)}Â° - ì¶”ì  ê°€ëŠ¥`);
              }
              
              if (!isTracking) {
                status.textContent = `ë‚˜ì¹¨ë°˜ì„ í™œì„±í™”í•˜ëŠ” ì¤‘... (${testMode ? 'í…ŒìŠ¤íŠ¸' : 'ìš´ì˜'} ëª¨ë“œ)`;
                setupCompass();
              }
            }
          },
          error => {
            let errorMessage = '';
            let detailInfo = '';
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMessage = 'ğŸš« ë¸Œë¼ìš°ì € ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë¨';
                if (isChrome) {
                  detailInfo = `
                    <strong>Chrome ê¶Œí•œ ë¬¸ì œ:</strong><br>
                    ğŸ”§ <strong>í•´ê²°ë°©ë²• (ìˆœì„œëŒ€ë¡œ ì‹œë„):</strong><br>
                    1ï¸âƒ£ ì£¼ì†Œì°½ ì™¼ìª½ ğŸ”’ ì•„ì´ì½˜ â†’ ìœ„ì¹˜ â†’ í—ˆìš©<br>
                    2ï¸âƒ£ Chrome ë©”ë‰´(â‹®) â†’ ì„¤ì • â†’ ê°œì¸ì •ë³´ ë° ë³´ì•ˆ â†’ ì‚¬ì´íŠ¸ ì„¤ì • â†’ ìœ„ì¹˜<br>
                    3ï¸âƒ£ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„<br>
                    4ï¸âƒ£ Chrome ì¬ì‹œì‘ í›„ ì¬ì‹œë„<br><br>
                    ğŸ’¡ Chromeì€ HTTPSì—ì„œë§Œ ìœ„ì¹˜ ì„œë¹„ìŠ¤ê°€ ì‘ë™í•©ë‹ˆë‹¤
                  `;
                } else {
                  detailInfo = `
                    <strong>ê¶Œí•œ ë¬¸ì œ:</strong> ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì ‘ê·¼ì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤<br>
                    ğŸ“± <strong>í•´ê²°ë°©ë²•:</strong><br>
                    â€¢ ì£¼ì†Œì°½ì˜ ìœ„ì¹˜ ì•„ì´ì½˜ í´ë¦­ â†’ í—ˆìš©<br>
                    â€¢ ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ì„œë¹„ìŠ¤ í—ˆìš©<br>
                    â€¢ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„
                  `;
                }
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = 'ğŸ“¡ GPS ì‹ í˜¸ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŒ';
                detailInfo = `
                  <strong>ì‹ í˜¸ ë¬¸ì œ:</strong> GPS í•˜ë“œì›¨ì–´ë‚˜ ì‹ í˜¸ ë¬¸ì œ<br>
                  ğŸ”§ <strong>í•´ê²°ë°©ë²•:</strong><br>
                  â€¢ ì‹¤ì™¸ë¡œ ì´ë™ (ì‹¤ë‚´/ì§€í•˜ëŠ” GPS ì‹ í˜¸ ì•½í•¨)<br>
                  â€¢ ê¸°ê¸°ì˜ ìœ„ì¹˜ ì„œë¹„ìŠ¤ í™œì„±í™” í™•ì¸<br>
                  â€¢ Wi-Fiì™€ ëª¨ë°”ì¼ ë°ì´í„° ëª¨ë‘ ì¼œê¸° (ë³´ì¡° ìœ„ì¹˜ ì •ë³´)
                `;
                break;
              case error.TIMEOUT:
                errorMessage = 'â±ï¸ GPS ì—°ê²° ì‹œê°„ ì´ˆê³¼';
                detailInfo = `
                  <strong>ì‹œê°„ ì´ˆê³¼:</strong> 3ì´ˆ ë‚´ì— ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í•¨<br>
                  ğŸ”§ <strong>í•´ê²°ë°©ë²•:</strong><br>
                  â€¢ í•˜ëŠ˜ì´ ì˜ ë³´ì´ëŠ” ê³³ìœ¼ë¡œ ì´ë™<br>
                  â€¢ ì ì‹œ ê¸°ë‹¤ë¦° í›„ ë‹¤ì‹œ ì‹œë„<br>
                  â€¢ ê¸°ê¸° ì¬ì‹œì‘ í›„ ì¬ì‹œë„
                `;
                break;
              default:
                errorMessage = 'âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                detailInfo = `ì˜¤ë¥˜ ì½”ë“œ: ${error.code}<br>ë©”ì‹œì§€: ${error.message}`;
                break;
            }
            
            console.log('Geolocation Error:', error.code, error.message);
            status.textContent = errorMessage;
            
            // ìƒì„¸í•œ í•´ê²° ë°©ë²• ì œê³µ
            document.getElementById('info').innerHTML = `
              <div style="text-align: left; font-size: 0.9em;">
                ${detailInfo}<br><br>
                
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                  <strong>ğŸ“ ìˆ˜ë™ ìœ„ì¹˜ ì…ë ¥:</strong><br>
                  <div style="margin: 10px 0;">
                    ìœ„ë„: <input type="number" id="manualLat" placeholder="37.5665" step="0.0001" style="width: 80px; margin: 0 5px; background: rgba(0,0,0,0.3); border: 1px solid #666; color: white; padding: 5px; border-radius: 3px;"><br>
                    ê²½ë„: <input type="number" id="manualLon" placeholder="126.9780" step="0.0001" style="width: 80px; margin: 0 5px; background: rgba(0,0,0,0.3); border: 1px solid #666; color: white; padding: 5px; border-radius: 3px;">
                    <button onclick="useManualLocation()" style="padding: 5px 10px; margin-left: 5px; font-size: 12px; margin-top: 5px;">í™•ì¸</button>
                  </div>
                  <small style="opacity: 0.7;">ğŸ’¡ í˜„ì¬ ìœ„ì¹˜ë¥¼ ëª¨ë¥´ê² ë‹¤ë©´ "ë‚´ ìœ„ì¹˜ ì¢Œí‘œ" êµ¬ê¸€ ê²€ìƒ‰</small>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,200,0,0.1); border-radius: 5px;">
                  <strong>ğŸ” Chrome ì¶”ê°€ ì²´í¬ì‚¬í•­:</strong><br>
                  <small>
                    â€¢ ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ì‹œë„í•´ë³´ê¸°<br>
                    â€¢ chrome://settings/content/location ì§ì ‘ ì ‘ì†<br>
                    â€¢ í™•ì¥ í”„ë¡œê·¸ë¨ì´ ë°©í•´í•˜ëŠ”ì§€ í™•ì¸<br>
                    â€¢ ê°œë°œìë„êµ¬(F12) Consoleì—ì„œ ìƒì„¸ ì˜¤ë¥˜ í™•ì¸
                  </small>
                </div>
              </div>
            `;
            startBtn.textContent = 'ë‹¤ì‹œ ì‹œë„';
            startBtn.disabled = false;
          },
          {
            enableHighAccuracy: true,
            timeout: 3000,
            maximumAge: 500
          }
        );
      } else {
        status.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
        startBtn.textContent = 'ë‹¤ì‹œ ì‹œë„';
        startBtn.disabled = false;
      }
    }
    
    function updateLocationDisplay() {
      const info = document.getElementById('info');
      const now = new Date();
      const timeStr = now.toLocaleTimeString() + '.' + String(now.getMilliseconds()).padStart(3, '0');
      const moon = moonPosition(now, currentLat, currentLon);
      
      const diff = ((currentMoonAzimuth - currentHeading + 540) % 360) - 180;
      
      info.innerHTML = `
        <div style="font-family: monospace; font-size: 0.9em;">
          <div style="background: rgba(0,255,0,0.1); padding: 8px; border-radius: 5px; margin-bottom: 10px;">
            ğŸ“ ì‹¤ì‹œê°„ ì¶”ì  [${timeStr}]
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left;">
            <div>
              <div><strong>ğŸŒ GPS ì¢Œí‘œ</strong></div>
              <div>ìœ„ë„: ${currentLat.toFixed(8)}Â°</div>
              <div>ê²½ë„: ${currentLon.toFixed(8)}Â°</div>
              <div style="font-size: 0.8em; opacity: 0.7;">ì •í™•ë„: Â±${currentAccuracy.toFixed(1)}m</div>
            </div>
            
            <div>
              <div><strong>ğŸ§­ ë‚˜ì¹¨ë°˜</strong></div>
              <div>ë‚´ ë°©í–¥: ${currentHeading.toFixed(1)}Â°</div>
              <div>ë‹¬ ë°©í–¥: ${moon.azimuth.toFixed(1)}Â°</div>
              <div>ì°¨ì´: ${Math.abs(diff).toFixed(1)}Â°</div>
            </div>
            
            <div>
              <div><strong>ğŸŒ™ ë‹¬ ì •ë³´</strong></div>
              <div>ê³ ë„: ${moon.altitude.toFixed(1)}Â°</div>
              <div>ìœ„ìƒ: ${(moon.phase * 100).toFixed(0)}%</div>
              <div style="font-size: 0.8em; color: ${testMode ? '#ffaa00' : '#00ff00'};">
                ${testMode ? 'ğŸ§ª í…ŒìŠ¤íŠ¸' : 'ğŸš€ ìš´ì˜'} ëª¨ë“œ
              </div>
            </div>
            
            <div>
              <div><strong>ğŸ“Š ìƒíƒœ</strong></div>
              <div style="color: ${Math.abs(diff) < 5 ? '#00ff00' : '#ffaa00'};">
                ${Math.abs(diff) < 5 ? 'ğŸ¯ ì •ì¡°ì¤€!' : (diff > 0 ? 'â¡ï¸ ìš°íšŒì „' : 'â¬…ï¸ ì¢ŒíšŒì „')}
              </div>
              <div style="font-size: 0.8em;">ì—…ë°ì´íŠ¸: 0.1ì´ˆ</div>
            </div>
          </div>
        </div>
      `;
    }
    
    function useManualLocation() {
      const lat = parseFloat(document.getElementById('manualLat').value);
      const lon = parseFloat(document.getElementById('manualLon').value);
      
      if (isNaN(lat) || isNaN(lon) || Math.abs(lat) > 90 || Math.abs(lon) > 180) {
        alert('ì˜¬ë°”ë¥¸ ìœ„ë„(-90~90)ì™€ ê²½ë„(-180~180)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      currentLat = lat;
      currentLon = lon;
      currentAccuracy = 0;
      
      const now = new Date();
      const moon = moonPosition(now, lat, lon);
      currentMoonAzimuth = moon.azimuth;
      
      // ë‹¬ ìœ„ìƒì— ë”°ë¥¸ ì´ëª¨ì§€ ì—…ë°ì´íŠ¸
      const moonIcon = document.getElementById('moonIcon');
      moonIcon.textContent = getMoonPhaseEmoji(moon.phase);
      
      const status = document.getElementById('status');
      
      // í…ŒìŠ¤íŠ¸ ëª¨ë“œì— ë”°ë¥¸ ë‹¬ ê³ ë„ ì²´í¬
      if (!testMode && moon.altitude < 0) {
        status.textContent = 'ë‹¬ì´ ì§€í‰ì„  ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤ (ìš´ì˜ ëª¨ë“œ)';
        document.getElementById('startBtn').textContent = 'ë‹¤ì‹œ í™•ì¸';
        document.getElementById('startBtn').disabled = false;
        console.log(`ìš´ì˜ ëª¨ë“œ: ë‹¬ ê³ ë„ ${moon.altitude.toFixed(1)}Â° - ì¶”ì  ë¶ˆê°€`);
      } else {
        console.log(`${testMode ? 'í…ŒìŠ¤íŠ¸' : 'ìš´ì˜'} ëª¨ë“œ: ë‹¬ ê³ ë„ ${moon.altitude.toFixed(1)}Â°${testMode && moon.altitude < 0 ? ' (ë¬´ì‹œ)' : ''}`);
        status.textContent = `ë‚˜ì¹¨ë°˜ì„ í™œì„±í™”í•˜ëŠ” ì¤‘... (${testMode ? 'í…ŒìŠ¤íŠ¸' : 'ìš´ì˜'} ëª¨ë“œ)`;
        setupCompass();
      }
    }
    
    function setupCompass() {
      const status = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      
      if (typeof DeviceOrientationEvent !== 'undefined') {
        // iOS 13+ ê¶Œí•œ ìš”ì²­
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission()
            .then(response => {
              if (response === 'granted') {
                startCompassTracking();
              } else {
                status.textContent = 'ë‚˜ì¹¨ë°˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤';
                startBtn.textContent = 'ì¶”ì  ì¤‘ì§€';
                startBtn.onclick = stopTracking;
                startBtn.disabled = false;
              }
            })
            .catch(err => {
              console.error(err);
              status.textContent = 'ë‚˜ì¹¨ë°˜ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨';
              startBtn.textContent = 'ì¶”ì  ì¤‘ì§€';
              startBtn.onclick = stopTracking;
              startBtn.disabled = false;
            });
        } else {
          // ì•ˆë“œë¡œì´ë“œ ë“±
          startCompassTracking();
        }
      } else {
        status.textContent = 'ì´ ê¸°ê¸°ëŠ” ë‚˜ì¹¨ë°˜ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ìœ„ì¹˜ë§Œ ì¶”ì )';
        startBtn.textContent = 'ì¶”ì  ì¤‘ì§€';
        startBtn.onclick = stopTracking;
        startBtn.disabled = false;
      }
    }
    
    function startCompassTracking() {
      const status = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      const moonIcon = document.getElementById('moonIcon');
      
      isTracking = true;
      status.textContent = `
