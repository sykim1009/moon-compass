<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moon Locator</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: black;
      color: white;
      margin: 0;
      padding: 1em;
    }
    #direction {
      margin-top: 20px;
      font-size: 1.2em;
      line-height: 1.6;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>üåô Moon Locator</h1>
  <button onclick="init()">Start</button>
  <div id="direction">Waiting for data...</div>

  <script>
    // ============= Îã¨ Í≥ÑÏÇ∞Ïö© Ìï®ÏàòÎì§ =============
    function toJulian(date) {
      return date / 86400000 + 2440587.5;
    }

    function fromJulian(j) {
      return new Date((j - 2440587.5) * 86400000);
    }

    function moonPosition(date, lat, lon) {
      const rad = Math.PI / 180;
      const day = toJulian(date) - 2451545.0;

      const L = (218.316 + 13.176396 * day) * rad;
      const M = (134.963 + 13.064993 * day) * rad;
      const F = (93.272 + 13.229350 * day) * rad;

      const lonEcl = L + 6.289 * rad * Math.sin(M);
      const latEcl = 5.128 * rad * Math.sin(F);

      const e = (23.439 - 0.0000004 * day) * rad;

      const ra = Math.atan2(
        Math.sin(lonEcl) * Math.cos(e) - Math.tan(latEcl) * Math.sin(e),
        Math.cos(lonEcl)
      );
      const dec = Math.asin(
        Math.sin(latEcl) * Math.cos(e) + Math.cos(latEcl) * Math.sin(e) * Math.sin(lonEcl)
      );

      const GMST = (18.697374558 + 24.06570982441908 * day) % 24;
      const LST = (GMST * 15 + lon) * rad;

      const H = LST - ra;
      const phi = lat * rad;

      const alt = Math.asin(Math.sin(phi) * Math.sin(dec) + Math.cos(phi) * Math.cos(dec) * Math.cos(H));
      const az = Math.atan2(
        -Math.sin(H),
        Math.tan(dec) * Math.cos(phi) - Math.sin(phi) * Math.cos(H)
      );

      return {
        azimuth: (az / rad + 360) % 360,
        altitude: alt / rad,
        dec: dec,
        ra: ra
      };
    }

    function getMoonPhase(date) {
      const lp = 2551443; // ÌèâÍ∑† ÏÇ≠ÎßùÏõî (Ï¥à)
      const newMoon = new Date(2000, 0, 6, 18, 14);
      const phase = ((date.getTime() - newMoon.getTime()) / 1000) % lp;
      return phase / lp;
    }

    function getMoonPhaseEmoji(phase) {
      if (phase < 0.1) return "üåë";
      if (phase < 0.3) return "üåí";
      if (phase < 0.45) return "üåì";
      if (phase < 0.55) return "üåî";
      if (phase < 0.7) return "üåï";
      if (phase < 0.8) return "üåñ";
      if (phase < 0.9) return "üåó";
      return "üåò";
    }

    function moonRiseSet(date, lat, lon) {
      const rad = Math.PI / 180;
      const h0 = -0.133 * rad; // Îã¨Ïùò Îú®Í≥† ÏßÄÎäî ÏãúÍ∞Ñ Í≥ÑÏÇ∞ÏùÑ ÏúÑÌïú Í≥†ÎèÑ Î≥¥Ï†ï (-0.133¬∞Îäî Îã¨Ïùò Î∞òÏßÄÎ¶Ñ Î∞è ÎåÄÍ∏∞ Íµ¥Ï†à Î≥¥Ï†ï)
      const phi = lat * rad;
      const lw = -lon * rad;

      // ÌòÑÏû¨ ÎÇ†ÏßúÏùò Ïú®Î¶¨Ïö∞Ïä§ ÎÇ†Ïßú
      const d = toJulian(date) - 2451545.0;

      // ÌïòÎ£® ÎèôÏïàÏùò Îã¨Ïùò ÏúÑÏπòÎ•º Ïó¨Îü¨ Î≤à ÌôïÏù∏ÌïòÏó¨ Îú®Í≥† ÏßÄÎäî ÏãúÍ∞ÑÏùÑ Í≥ÑÏÇ∞
      const times = {};
      let riseTime = null;
      let setTime = null;

      // 24ÏãúÍ∞Ñ ÎèôÏïà 1ÏãúÍ∞Ñ Í∞ÑÍ≤©ÏúºÎ°ú ÌôïÏù∏
      for (let i = 0; i < 24; i++) {
        const currentTime = fromJulian(toJulian(date) + i / 24);
        const nextTime = fromJulian(toJulian(date) + (i + 1) / 24);
        
        const mp1 = moonPosition(currentTime, lat, lon);
        const mp2 = moonPosition(nextTime, lat, lon);

        const GMST1 = (18.697374558 + 24.06570982441908 * (toJulian(currentTime) - 2451545.0)) % 24;
        const LST1 = (GMST1 * 15 + lon) * rad;
        const H1 = LST1 - mp1.ra;

        const GMST2 = (18.697374558 + 24.06570982441908 * (toJulian(nextTime) - 2451545.0)) % 24;
        const LST2 = (GMST2 * 15 + lon) * rad;
        const H2 = LST2 - mp2.ra;

        const alt1 = Math.asin(Math.sin(phi) * Math.sin(mp1.dec) + Math.cos(phi) * Math.cos(mp1.dec) * Math.cos(H1));
        const alt2 = Math.asin(Math.sin(phi) * Math.sin(mp2.dec) + Math.cos(phi) * Math.cos(mp2.dec) * Math.cos(H2));

        // Í≥†ÎèÑÍ∞Ä h0 (-0.133¬∞)Î•º ÏßÄÎÇòÍ∞ÄÎäîÏßÄ ÌôïÏù∏
        if (alt1 <= h0 && alt2 > h0) {
          // Îú®Îäî ÏãúÍ∞Ñ Î≥¥Í∞Ñ
          const fraction = (h0 - alt1) / (alt2 - alt1);
          riseTime = new Date(currentTime.getTime() + fraction * 3600000);
        } else if (alt1 >= h0 && alt2 < h0) {
          // ÏßÄÎäî ÏãúÍ∞Ñ Î≥¥Í∞Ñ
          const fraction = (h0 - alt1) / (alt2 - alt1);
          setTime = new Date(currentTime.getTime() + fraction * 3600000);
        }
      }

      if (riseTime) times.rise = riseTime;
      if (setTime) times.set = setTime;

      return times;
    }

    // ============= Î©îÏù∏ Î°úÏßÅ =============
    let moonData = null;
    let updateTimer = null;

    function init() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          function update() {
            const now = new Date();
            const moon = moonPosition(now, lat, lon);
            const phase = getMoonPhase(now);
            const emoji = getMoonPhaseEmoji(phase);
            const times = moonRiseSet(now, lat, lon);

            let text =
              `Your position: ${lat.toFixed(4)}, ${lon.toFixed(4)}\n` +
              `Moon ‚Üí ${emoji}\n` +
              `Azimuth: ${moon.azimuth.toFixed(1)}¬∞, Altitude: ${moon.altitude.toFixed(1)}¬∞\n`;

            if (times.rise && times.set) {
              text += `Rise: ${times.rise.toLocaleTimeString()}\nSet: ${times.set.toLocaleTimeString()}`;
            } else {
              text += `Rise/Set: N/A`;
            }

            document.getElementById("direction").textContent = text;
            moonData = moon;
          }

          update();
          if (updateTimer) clearInterval(updateTimer);
          updateTimer = setInterval(update, 500); // 0.5Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏

          setupCompass();
        });
      } else {
        alert("Geolocation not supported");
      }
    }

    function setupCompass() {
      if (window.DeviceOrientationEvent) {
        window.addEventListener("deviceorientationabsolute", updateHeading, true);
        window.addEventListener("deviceorientation", updateHeading, true);
      }
    }

    function updateHeading(e) {
      if (!moonData) return;
      if (e.alpha != null) {
        const heading = 360 - e.alpha; // Î∂ÅÏ™Ω Í∏∞Ï§Ä

        // Í∏∞Ï°¥ ÌÖçÏä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
        let text = document.getElementById("direction").textContent.split('\n').slice(0, 5).join('\n');
        text += `\nYour heading: ${heading.toFixed(0)}¬∞`;

        const diff = ((moonData.azimuth - heading + 540) % 360) - 180;
        if (Math.abs(diff) < 15) {
          text += `\nüëâ Pointing at the moon!`;
        } else if (diff > 0) {
          text += `\n‚Üó Turn right ${Math.abs(diff).toFixed(0)}¬∞`;
        } else {
          text += `\n‚Üñ Turn left ${Math.abs(diff).toFixed(0)}¬∞`;
        }

        document.getElementById("direction").textContent = text;
      }
    }
  </script>
</body>
</html>